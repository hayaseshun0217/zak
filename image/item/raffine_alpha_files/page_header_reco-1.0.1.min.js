/*
 page_header_reco.js 1.0.0
 Copyright (c) 2013 Rakuten.Inc
 Date : 2013-03-27 16:45:16
*/
(function(k,h){function m(a){cssStr=a.css("cssText");null==cssStr&&(cssStr="");a.css("cssText",cssStr+"; display:block!important;")}function j(a){cssStr=a.css("cssText");null==cssStr&&(cssStr="");a.css("cssText",cssStr+"; display:none!important;")}if(k.jQuery!==h){jQuery.noConflict();var b=jQuery;if(b.RJS_Helpers&&b().PAGE_Slideshow){var l=b("#rakutenLimitedId_extshopParts .titleH2"),o=b("#rakutenLimitedId_extshopParts #extpartsDetailLink");b("#rakutenHeaderExtPartsSpace");var n=!1,p="shop_header_reco",
q="shop_header_rk",i=null,i=new function(){var a=this;b.extend(a,{settings:{common:{noready:[0,"Int","^[0-1]$"],pagespeed:[100,"Range","0,9999"],opacityspeed:[100,"Range","0,9999"],omitname:[38,"Range","0,100"],imagesize:["80x80","Str","^[1-9]{1}[0-9]{1,2}x[1-9]{1}[0-9]{1,2}"],autoslidetime:[2,"Range","1,99"],autoslideflag:["next","Str","^(next|prev)$"],autoslide:[0,"Int","^[0-1]$"],autoresize:[1,"Int","^[0-1]$"],impvar:["","Str","^[a-zA-Z0-9_]{3,64}$"],impdisp:["","Str","^[a-zA-Z0-9_]{3,64}$"],impnodisp:["",
"Str","^[a-zA-Z0-9_]{3,64}$"],verticalmode:[0,"Int","^[1]$"],ajaxtimer:[3,"Range","1,99"],recothreshold:[5,"Int","^[1-9]$"],rankingshuffle:[1,"Int","^[0-1]$"],requestwait:[500,"Range","1,9999"],checkinterval:[100,"Range","1,9999"],shopid:[0,"Range","1,999999"],itemid:[0,"Range","1,99999999"],shopurl:["","Str","^[a-zA-Z0-9_]{3,64}$"],mngnumber:["","Str","^[a-zA-Z0-9_]{3,64}$"],gid:[0,"Range","1,999999"],api:["","Str","^(recommend1|recommend2|ranking1|ranking2|esper1|ashiato)$"],maxcount:[30,"Range",
"1,9999"],dispresize:[1,"Int","^[0-1]$"]},ashiato:{maxitem:[1,"Int","^[1-9]$"],url:["","Str","^http(s?)+(:\\/\\/[a-zA-Z0-9_\\-\\.]+)(\\.rakuten\\.co\\.jp\\/)+([a-zA-Z0-9_&=\\?\\-\\.\\/]+)$"],sid:["","Str","^[a-zA-Z0-9_\\-]{3,64}$"]},reco:{maxitem:[3,"Int","^[1-9]$"],url:["","Str","^http(s?)+(:\\/\\/[a-zA-Z0-9_\\-\\.]+)(\\.rakuten\\.co\\.jp\\/)+([a-zA-Z0-9_&=\\?\\-\\.\\/]+)$"],sid:["","Str","^[a-zA-Z0-9_\\-]{3,64}$"]},ranking:{url:["","Str","^http(s?)+(:\\/\\/[a-zA-Z0-9_\\-\\.]+)(\\.rakuten\\.co\\.jp\\/)+([a-zA-Z0-9_&=\\?\\-\\.\\/]+)$"],
genrelayer:[2,"Int","^[1-9]$"],sid:["","Str","^[a-zA-Z0-9_\\-]{3,64}$"],maxitem:[3,"Int","^[1-9]$"]},esper:{maxitem:["3","Int","^[1-9]$"],url:["","Str","^http(s?)+(:\\/\\/[a-zA-Z0-9_\\-\\.]+)(\\.rakuten\\.co\\.jp\\/)+([a-zA-Z0-9_&=\\?\\-\\.\\/]+)$"],sid:["","Str","^[a-zA-Z0-9_\\-]{3,64}$"],namelen:[10,"Range","1,9999"]},shopreco:{maxitem:[3,"Int","^[1-9]$"],url:["","Str","^http(s?)+(:\\/\\/[a-zA-Z0-9_\\-\\.]+)(\\.rakuten\\.co\\.jp\\/)+([a-zA-Z0-9_&=\\?\\-\\.\\/]+)$"],sid:["","Str","^[a-zA-Z0-9_\\-]{3,64}$"]}},
eobj:{common:{config:b("#extpartsCommonConfig"),existItem:b("#rakutenLimitedId_extshopParts"),altContents:b("#commonAlteredContents"),recoSlider:b("#extpartsSlider"),loading:b("#extpartsLoading")},ashiato:{config:b("#ashiatoConfig"),prevButton:b("#extpartsPrevButton"),nextButton:b("#extpartsNextButton"),proto:b("#prototypeRecoItem"),itemsDisplay:b("#extpartsItemsDisplay"),altContents:b("#extpartsAlteredContents")},reco:{config:b("#recoDataConfig"),prevButton:b("#extpartsPrevButton"),nextButton:b("#extpartsNextButton"),
proto:b("#prototypeRecoItem"),itemsDisplay:b("#extpartsItemsDisplay"),altContents:b("#extpartsAlteredContents")},ranking:{config:b("#rankingDataConfig"),prevButton:b("#extpartsPrevButton"),nextButton:b("#extpartsNextButton"),proto:b("#prototypeRankingItem"),itemsDisplay:b("#extpartsItemsDisplay"),altContents:b("#extpartsAlteredContents")},esper:{config:b("#esperDataConfig"),prevButton:b("#extpartsPrevButton"),nextButton:b("#extpartsNextButton"),proto:b("#prototypeEsperItem"),itemsDisplay:b("#extpartsItemsDisplay"),
altContents:b("#extpartsAlteredContents")},shopreco:{config:b("#shopRecoConfig"),prevButton:b("#extpartsPrevButton"),nextButton:b("#extpartsNextButton"),proto:b("#prototypeRecoItem"),itemsDisplay:b("#extpartsItemsDisplay"),altContents:b("#extpartsAlteredContents")}},status:{error:!1,isTimeout:!1},props:{ashiato:{items:[],proto:{html:"",height:0,width:0,identifiers:{itemurl:["",/\#ITEMURL\#/g,""],imageurl:['<img src="',/\#ITEMIMGELE\#/g,'" >'],itemname:["",/\#ITEMNAME\#/g,""],itemprice:["",/\#ITEMPRICE\#/g,
""],itemdelivery:["",/\#ITEMDELIVERY#/g,""]}}},reco:{items:[],proto:{html:"",height:0,width:0,identifiers:{itemurl:["",/\#ITEMURL\#/g,""],imageurl:['<img src="',/\#ITEMIMGELE\#/g,'" >'],itemname:["",/\#ITEMNAME\#/g,""],itemprice:["",/\#ITEMPRICE\#/g,""],itemdelivery:["",/\#ITEMDELIVERY#/g,""]}}},ranking:{items:[],proto:{html:"",height:0,width:0,identifiers:{rank:["",/\#ITEMRANK\#/g,""],itemurl:["",/\#ITEMURL\#/g,""],imageurl:['<img src="',/\#ITEMIMGELE\#/g,'" >'],itemname:["",/\#ITEMNAME\#/g,""],
itemprice:["",/\#ITEMPRICE\#/g,""]}}},esper:{items:[],proto:{html:"",height:0,width:0,identifiers:{itemurl:["",/\#ITEMURL\#/g,""],imageurl:['<img src="',/\#ITEMIMGELE\#/g,'" >'],itemname:["",/\#ITEMNAME\#/g,""],itemprice:["",/\#ITEMPRICE\#/g,""],catchcopy:["",/\#CATCHCOPY\#/g,""],itemdelivery:["",/\#ITEMDELIVERY#/g,""]}}},currentAshiatoIndex:!1,requestPermission:!0,requestPermissionTimer:null,checkWaitInterval:null,initialized:!1,catalystType:null,beginProcess:!1},initialize:function(){a.loadSettings()},
loadSettings:function(){j(a.eobj.reco.proto);a.settings.common=b.RJS_Helpers.readAttr(a.eobj.common.config,a.settings.common);a.settings.ashiato=b.RJS_Helpers.readAttr(a.eobj.ashiato.config,a.settings.ashiato);a.settings.reco=b.RJS_Helpers.readAttr(a.eobj.reco.config,a.settings.reco);a.settings.ranking=b.RJS_Helpers.readAttr(a.eobj.ranking.config,a.settings.ranking);a.settings.esper=b.RJS_Helpers.readAttr(a.eobj.esper.config,a.settings.esper);a.settings.shopreco=b.RJS_Helpers.readAttr(a.eobj.shopreco.config,
a.settings.shopreco);b.extend(a.settings.ashiato,a.settings.common,a.settings.ashiato);b.extend(a.settings.reco,a.settings.common,a.settings.reco);b.extend(a.settings.ranking,a.settings.common,a.settings.ranking);b.extend(a.settings.esper,a.settings.common,a.settings.esper);b.extend(a.settings.shopreco,a.settings.common,a.settings.shopreco);a.settings.ashiato.autoslide=0;a.settings.ashiato.maxitem=1;a.settings.reco.autoslide=0;a.settings.esper.autoslide=0;a.settings.shopreco.autoslide=0;a.settings.ranking.autoslide=
0;if(""==a.settings.ashiato.url||512<a.settings.ashiato.url.length||""==a.settings.reco.url||512<a.settings.reco.url.length||""==a.settings.ranking.url||512<a.settings.ranking.url.length||""==a.settings.shopreco.url||512<a.settings.shopreco.url.length||0===a.eobj.ashiato.proto.length||0===a.eobj.reco.proto.length||0===a.eobj.ranking.proto.length||0===a.eobj.shopreco.proto.length||0===a.eobj.esper.proto.length)return!1;a.settings.common.autoslidetime*=1E3;a.settings.common.ajaxtimer*=1E3;a.eobj.common.config.remove();
a.eobj.ashiato.config.remove();a.eobj.reco.config.remove();a.eobj.ranking.config.remove();a.eobj.shopreco.config.remove();a.eobj.esper.config.remove();return!0},displayRecoLoading:function(){j(a.eobj.reco.altContents);j(a.eobj.common.altContents);j(a.eobj.common.recoSlider);a.eobj.common.existItem.show();m(a.eobj.common.loading)},begin:function(){"recommend1"==a.settings.common.api?a.getRecoData():"recommend2"==a.settings.common.api?a.getShopRecoData():"ranking1"==a.settings.common.api?a.getRankingData():
"esper1"==a.settings.common.api?a.getEsperData("esper1"):"ashiato"==a.settings.common.api&&a.getAshiatoData()},dispDataHandling:function(d){"recommend1"==d?setTimeout(function(){a.getRankingData()},1):(a.eobj.common.existItem.hide(),j(a.eobj.common.loading),n=!0,a.props.catalystType="shop_header_none",pageMultirecoMouseOver!=h&&pageMultirecoMouseOver(a.props.catalystType))},getAshiatoData:function(){function d(c){if(a.status.isTimeout)return!1;clearTimeout(e);if(c.code===h||c.num===h)return!1;if("0"!=
c.code)return("1"==c.code||"8"==c.code)&&a.regImpressionCode(a.settings.common.impnodisp),!1;if(1>c.items.length)return!1;var d=c.items.length;if(d>a.settings.common.maxcount)d=a.settings.common.maxcount;for(var b=0;b<d;b++)c.items[b].shopid==a.settings.common.shopid&&c.items[b].itemid==a.settings.common.itemid||/^http:\/\/item.rakuten.co.jp/.test(c.items[b].itemurlfull)&&a.props.ashiato.items.push({itemname:a.editItemname(c.items[b].itemname),itemurl:a.editItemurl(c.items[b].itemurlfull,a.settings.ashiato.sid),
imageurl:""!=c.items[b].imageurl?a.editImageurl(c.items[b].imageurl):c.items[b].imageurl64,mngnumber:c.items[b].mngnumber,shopurl:c.items[b].shopurl,itemid:c.items[b].itemid,shopid:c.items[b].shopid,genreidlist:c.items[b].genreidlist,itemdelivery:a.editPostage(c.items[b].postageflg),itemprice:a.editPrice(""+c.items[b].itemprice)});if(0>=a.props.ashiato.items.length||c.item_count<a.settings.common.recothreshold)return!1;l.text("最近チェックした商品");return a.displayRecoData(a.props.ashiato,a.eobj.ashiato,a.settings.ashiato)}
var e;a.status.isTimeout=!1;try{e=setTimeout(function(){a.status.isTimeout=!0},a.settings.common.ajaxtimer),b.ajax({url:a.settings.ashiato.url,cache:!1,dataType:"jsonp",scriptCharset:"euc-jp",timeout:a.settings.common.ajaxtimer,success:function(c){d(c)||a.dispDataHandling("ashiato")},error:function(){a.dispDataHandling("ashiato")}})}catch(f){return a.dispDataHandling("ashiato"),!1}return!0},getRecoData:function(){function d(c){if(a.status.isTimeout)return!1;clearTimeout(e);if(c.status===h||c.item_count===
h||"Success"!=c.status&&"NotFound"!=c.status)return!1;var b=[],d=c.item.length;if(d>a.settings.common.maxcount)d=a.settings.common.maxcount;for(var g=0;g<d;g++)b.push({itemname:a.editItemname(c.item[g].item_name),itemurl:a.editItemurl(c.item[g].item_url,a.settings.reco.sid),imageurl:a.editImageurl(c.item[g].image_url_80),itemprice:a.editPrice(c.item[g].item_price),itemdelivery:a.editPostage(c.item[g].postage_flg)});a.props.reco.items=b;if(c.item_count<a.settings.common.recothreshold)return!1;a.props.catalystType=
p;l.text("この商品を買った人は、こんな商品も買っています");return a.displayRecoData(a.props.reco,a.eobj.reco,a.settings.reco)}if(a.props.requestPermission){var e;a.status.isTimeout=!1;try{e=setTimeout(function(){a.status.isTimeout=!0},a.settings.common.ajaxtimer),b.ajax({url:a.settings.reco.url,cache:!1,dataType:"jsonp",data:{item_id:a.settings.common.shopid+"_"+a.settings.common.itemid},scriptCharset:"euc-jp",timeout:a.settings.common.ajaxtimer,success:function(b){d(b)||(clearTimeout(e),a.dispDataHandling("recommend1"))},
error:function(){clearTimeout(e);a.dispDataHandling("recommend1")}})}catch(f){return clearTimeout(e),a.dispDataHandling("recommend1"),!1}return!0}clearInterval(a.props.checkWaitInterval);a.props.checkWaitInterval=setInterval(function(){a.props.requestPermission&&(clearInterval(a.props.checkWaitInterval),a.getRecoData())},a.settings.common.checkinterval)},getRankingData:function(){function d(c){if(a.status.isTimeout)return!1;clearTimeout(e);if(c.status===h||c.num===h||"Success"!=c.status&&"GenreNotFound"!=
c.status)return!1;if(c.num<a.settings.common.recothreshold)return a.regImpressionCode(a.settings.common.impnodisp),!1;var d=[],f=c.items.length;if(f>a.settings.common.maxcount)f=a.settings.common.maxcount;ranknum=1;for(var g=0;g<f;g++){var i=(/R2=([^\&]+)/.exec(c.items[g].itemurl)||[])[1],j=!0;if(i===h&&/^http:\/\/item.rakuten.co.jp/.test(c.items[g].itemurl))j=!1,i=c.items[g].itemurl;i!==h&&(d.push({rank:ranknum+"位",itemname:a.editItemname(c.items[g].itemname),itemurl:a.editItemurl(c.items[g].itemurl,
a.settings.ranking.sid,j),imageurl:a.editImageurl(c.items[g].imageurl64),itemprice:a.editPrice(c.items[g].price)}),ranknum++)}if(d.length<a.settings.common.recothreshold)return a.regImpressionCode(a.settings.common.impnodisp),!1;if(a.props.ranking.items==h)a.props.ranking.items=[];a.props.ranking.items=b.merge(a.props.ranking.items,d);a.props.catalystType=q;l.text("この商品のジャンルランキング");return a.displayRecoData(a.props.ranking,a.eobj.ranking,a.settings.ranking)}var e;a.status.isTimeout=!1;try{e=setTimeout(function(){a.status.isTimeout=
!0},a.settings.common.ajaxtimer),gid=a.settings.common.gid,gid===h&&(gid=0),b.ajax({url:a.settings.ranking.url,cache:!0,dataType:"jsonp",data:{gid:gid},jsonpCallback:"jsonp0123456789012",scriptCharset:"euc-jp",timeout:a.settings.common.ajaxtimer,success:function(b){d(b)||(clearTimeout(e),a.dispDataHandling("ranking1"))},error:function(){clearTimeout(e);a.dispDataHandling("ranking1")}})}catch(f){return clearTimeout(e),a.dispDataHandling("ranking1"),!1}return!0},displayRecoData:function(d,e,f){a.displayRecoLoading();
if(0===e.proto.length)return!1;d.proto.width=e.proto.outerWidth();if(0==d.proto.width)d.proto.width=e.proto.css("width").replace("px","");d.proto.height=e.proto.outerHeight();d.proto.html=e.proto.html();if(""==d.proto.html)return!1;j(e.proto);e.itemsDisplay.empty();e.prevButton.find("a").unbind("click");e.nextButton.find("a").unbind("click");j(e.altContents);a.eobj.common.loading.remove();m(a.eobj.common.recoSlider);a.regImpressionCode(a.settings.common.impdisp);topValue=b(k).scrollTop()+40;a.eobj.common.existItem.css("top",
topValue);a.eobj.common.existItem.show();e.itemsDisplay.PAGE_Slideshow(a,{settings:f,itemPrototype:d.proto,eobj:e,items:d.items,events:{beforeFirstRender:function(a,b){b.props.initialized=!0;m(e.itemsDisplay)},afterFirstRender:function(a,b){b.props.requestPermission=!1;b.props.requestPermissionTimer=setTimeout(function(){b.props.requestPermission=!0},b.settings.common.requestwait)}}});null!=a.props.catalystType&&pageMultirecoMouseOver!=h&&pageMultirecoMouseOver(a.props.catalystType);return!0},regImpressionCode:function(b){return k[a.settings.common.impvar]===
h||""==b?"":k[a.settings.common.impvar]=b},shuffle:function(a){for(var a=Array.apply(null,a),b=a.length;b;){var f=Math.floor(Math.random()*b),c=a[--b];a[b]=a[f];a[f]=c}return a},endsWith:function(a,b){var f=a.length-b.length;return 0<=f&&a.lastIndexOf(b)===f},editItemname:function(d){d=b.RJS_Helpers.omitStr(d,a.settings.common.omitname,"…");b.browser.msie||(d=d.split("").join(String.fromCharCode(8203)));return d},editImageurl:function(d){""!=d&&(d=b.RJS_Helpers.urlParameter(d,{_ex:a.settings.common.imagesize}));
return d},editItemurl:function(a,e,f){""!=e&&(a=f?b.RJS_Helpers.urlR2Parameter(a,{"s-id":e},!1):b.RJS_Helpers.urlParameter(a,{"s-id":e},!1));return a},getEsperData:function(d){jsonData=b("#search_items").text();if(null==jsonData||""==jsonData)return a.dispDataHandling(d),!1;try{var e;var f=b.parseJSON(jsonData);if(f.searchItems.hits===h||f.searchItems===h)e=!1;else{var c=f.searchItems.items;if(1>f.searchItems.hits)e=!1;else{var i=[],j=c.length;if(j>a.settings.common.maxcount)j=a.settings.common.maxcount;
for(var g=0;g<j;g++)imageurl=c[g].imagepath,shopurl=c[g].shopurl,itemurl=c[g].itemurl,itemname=c[g].itemname,itemprice=c[g].itemprice,reviewave=c[g].reviewave,reviewnum=c[g].reviewnum,itemtype=c[g].itemtype,catchcopy=c[g].catchcopy,creditflg=c[g].creditflg,postageflg=c[g].postageflg,i.push({itemname:a.editItemname2(itemname),itemurl:a.editItemurl2(shopurl,itemurl,itemtype,a.settings.esper.sid),imageurl:a.editImageurl2(imageurl),itemprice:a.editPrice(itemprice),catchcopy:a.editCatchcopy(catchcopy),
itemdelivery:a.editPostage(postageflg)});a.props.esper.items=i;f.searchItems.keyword==h||""==f.searchItems.keyword?l.text("同一ジャンルの商品"):l.text("「"+b.trim(f.searchItems.keyword)+"」の楽天検索結果");o.html('<a href="http://search.rakuten.co.jp/search/mall/'+b.trim(f.searchItems.keyword)+"/"+f.searchItems.genreId+'/">検索結果をもっと見る</a>');e=a.displayRecoData(a.props.esper,a.eobj.esper,a.settings.esper)}}e||a.dispDataHandling(d)}catch(k){a.dispDataHandling(d)}return!0},editItemname2:function(b){return b.length>a.settings.esper.namelen?
b.substring(0,a.settings.esper.namelen)+"...":b},editPostage:function(a){if(""!=a){if("0"===a)return"送料込";if("1"===a)return"送料別"}return""},editPrice:function(a){var b="",f=0;if("undefined"==typeof a)return"";for(var c=a.length-1;0<=c;c--)b=a.charAt(c)+b,f++,0==f%3&&0!=c&&(b=","+b);return b+"円"},editItemurl2:function(b,e,f,c,h){return 1==f||5==f?a.editItemurl("http://item.rakuten.co.jp/"+b+"/"+e,c,h):2==f?a.editItemurl("http://gbuy.item.rakuten.co.jp/"+b+"/g/"+e,c,h):3==f?a.editItemurl("http://sa.item.rakuten.co.jp/"+
b+"/a/"+e,c,h):""},editImageurl2:function(b){return""!=b?a.editImageurl("http://thumbnail.image.rakuten.co.jp/"+b):""},editCatchcopy:function(a){return a},getShopRecoData:function(){function d(b){if(a.status.isTimeout)return!1;clearTimeout(e);if(b.code===h||b.num===h||0!=b.code)return!1;var d=[],f=b.items.length;if(f>a.settings.common.maxcount)f=a.settings.common.maxcount;for(var g=0;g<f;g++)d.push({itemname:a.editItemname(b.items[g].itemname),itemurl:a.editItemurl(b.items[g].itemurlfull,a.settings.reco.sid),
imageurl:a.editImageurl(b.items[g].imageurl128),itemprice:a.editPrice(b.items[g].itemprice),itemdelivery:a.editPostage(b.items[g].postageflg)});a.props.reco.items=d;if(b.num<a.settings.common.recothreshold)return!1;l.text("この商品を買った人は、こんな商品も買っています");return a.displayRecoData(a.props.reco,a.eobj.reco,a.settings.reco)}if(a.props.requestPermission){var e;a.status.isTimeout=!1;try{e=setTimeout(function(){a.status.isTimeout=!0},a.settings.common.ajaxtimer),b.ajax({url:a.settings.shopreco.url,cache:!1,dataType:"jsonp",
data:{shop_id:a.settings.common.shopid,item_ids:a.settings.common.itemid},scriptCharset:"euc-jp",timeout:a.settings.common.ajaxtimer,success:function(b){d(b)||(clearTimeout(e),a.dispDataHandling("recommend2"))},error:function(){a.dispDataHandling("recommend2")}})}catch(f){return clearTimeout(e),a.dispDataHandling("recommend2"),!1}return!0}clearInterval(a.props.checkWaitInterval);a.props.checkWaitInterval=setInterval(function(){a.props.requestPermission&&(clearInterval(a.props.checkWaitInterval),a.getShopRecoData())},
a.settings.common.checkinterval)},show:function(){if(!0!=a.props.initialized){if(!a.props.beginProcess)a.props.beginProcess=!0,a.begin()}else topValue=b(k).scrollTop()+40,a.eobj.common.existItem.css("top",topValue),a.eobj.common.existItem.show(),a.eobj.reco.itemsDisplay.resize()},hide:function(){a.eobj.common.existItem.hide()}})};i.initialize();b("#rakutenLimitedId_header .riShopTermInrRec").click(function(){return!1}).mousemove(function(){!0!=n&&(i.show(),null!=i.props.catalystType&&pageMultirecoMouseOver!=
h&&pageMultirecoMouseOver(i.props.catalystType))});i.eobj.common.existItem.mouseout(function(a){var d=b(this).offset();(a.pageX<d.left||d.left+b(this).innerWidth()<a.pageX||a.pageY<d.top||d.top+b(this).innerHeight()<a.pageY)&&i.hide()});b(k).scroll(function(){i.hide()})}}})(this);
